name: Download from SharePoint

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Get Access Token
        id: get_token
        run: |
          echo "Requesting access token..."
          curl -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=${{ secrets.CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CLIENT_SECRET }}" \
            -d "scope=https://graph.microsoft.com/.default" \
            https://login.microsoftonline.com/${{ secrets.TENANT_ID }}/oauth2/v2.0/token \
            | jq -r '.access_token' > access_token.txt
          echo "Access token retrieved successfully."
          echo "${{ secrets.SP_ACCESS_TOKEN }}" > access_token.txt
          echo $(cat access_token.txt)

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create ZIP archive
        run: |
          zip -r my_archive.zip README.md

      - name: Upload ZIP to Microsoft Drive
        env:
            DRIVE_ID: ${{ secrets.DRIVE_ID }}
            FOLDER_NAME: 'nav-dx-guidancee'
            ACCESS_TOKEN: ${{ secrets.SP_ACCESS_TOKEN }}
            FILE_NAME: 'my_archive.zip'
        run: |
            curl -X PUT \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "Content-Type: application/zip" \
              -T my_archive.zip \
              "https://graph.microsoft.com/v1.0/drives/$DRIVE_ID/root:/$FOLDER_NAME/$FILE_NAME:/content"