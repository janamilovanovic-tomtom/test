// Copyright (C) 2018 TomTom NV. All rights reserved.
//
// This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
// used for internal evaluation purposes or commercial use strictly subject to separate
// license agreement between you and TomTom NV. If you are the licensee, you are only permitted
// to use this software in accordance with the terms of your license agreement. If you are
// not the licensee, you are not authorized to use this software in any manner and should
// immediately return or destroy it.

= Lane and Arrow Recommendations in GO SDK

== Status

Proposed

== Problem

In https://jira.tomtomgroup.com/browse/GOSDK-10625[GOSDK-10625], there
is a route through a roundabout where all five lanes for entering the
roundabout are recommended.  However, the route immediately exits the
roundabout, and to perform that maneuver the car must enter the
roundabout in one of the two right-most lanes.

== Background

The lane guidance produced by the instruction engine is a nested data
type:

* The entire data structure is a `LaneGuidanceScenario` modelling a
  stretch of the route
* Each `LaneGuidanceScenario` contains multiple `LaneSegment` objects
  representing a portion of the scenario with the same lane
  configuration
* Each `LaneSegment` contains a `LaneInfo` object for each lane
* Each `LaneInfo` contains multipe `Arrow` objects.

Within this structure there are two flags representing
recommendations: `LaneInfo` objects can be recommended, and `Arrow`
objects can be recommended.  These recommendations have different
intended meanings:

* `LaneInfo::is_recommended` indicates that a lane is one of the most
  efficient ways to drive from a lane at the start of the road stretch
  to a lane at the end of the road stretch.
* `Arrow::is_recommended` indicates that if the driver happens to be
  in that lane, this is which of the possible directions they should
  drive along that lane.

A consequence of this structure is that we sometimes recommend arrows
on lanes that are themselves not recommended.

Here are two example situations.  The diagrams are taken from
https://miro.com/app/board/uXjVMFApTsA=/[this Miro board].

=== Example: Highway Exit

This diagram shows a route exiting a five-lane highway to eventually
turn right.  It contains three separate maneuvers.  The lane guidance
at the first maneuver is shown.

image::2023-05-25T13:19:59+0200-lane-arrow-recommendations/NAV-110863
lane arrow recommendations - Exit Highway.jpg[width=400]

The lane-level router in this case recommends staying in the
right-hand lane throughout this stretch of the route, since it
involves the fewest lane changes footnote:[In fact lane-level routing
will always recommend at least one route from each of the five
possible starting lanes.  To simplify this example, however, assume
that the lane-level router recommends switching to the right-most lane
as soon as possible, before the first maneuver.].  Therefore only the
right-most lane is recommended.  However, the right-most three lanes
are all viable ways to continue, and so in each of those the relevant
arrow is recommended.

Notice in particular the guidance for the middle lane.  It is not
recommended.  There are two ways to drive along this lane, one going
straight and the other bearing right.  We highlight the "bear right"
arrow to indicate that if the driver chooses to use this lane, that is
the direction they must drive.  This type of guidance is the primary
use case for recommending arrows on lanes that are not themselves
recommended.

=== Example: Roundabout

This diagram shows a route joining a multi-lane roundabout from an
entrance with two lanes, and then immediately taking an exit with one
lane.  In this example the distance between entrance and exit is short
enough that we have only one instruction, rather than separate enter
and exit roundabout instructions.  The lane guidance at that maneuver
is shown.

image::2023-05-25T13:19:59+0200-lane-arrow-recommendations/NAV-110863
lane arrow recommendations - Roundabout.jpg[width=400]

Again, the lane-level router in this case recommends staying in the
right-hand lane in order to avoid lane changes, and so only the
right-hand lane is recommended.  However, it is still possible to use
the left-hand lane, and so the arrow is recommended.  The arrows are
both straight, although you may expect that the right-hand lane would
have a right-turn arrow.  This is the best compromise we currently
have for indicating a lane that joins a roundabout.  This is because
arrows do not indicate the long-term destination of the scenario,
rather they only describe the road immediately following the maneuver.

=== UI Interpretation

The diagrams above also show how the data produced by the API is
displayed by both HCP3 and BMW UI implementations.  In both cases
there is no facility to display both lane and arrow-level
recommendations.  Instead each lane is represented by a single glyph,
which may be highlighted to indicate a recommendatation.  HCP3 is able
to show multiple arrows in one glyph, with each independently
highlighted.  BMW can only show one arrow in a glyph.

HCP3 implemented, on our advice, an algorithm in which only
recommended arrows in recommended lanes are highlighted footnote:[In
case there are no recommended arrows in a recommended lane, the
fallback is to highlight all recommended arrows.].  They are able to
do this because as NK2 users they have access to both lane and
arrow-level recommendations.  BMW is using GO SDK, which only exposes
arrow recommendations.

In the highway exit example, the result is that the two UIs are
displaying different things.  HCP3 indicates which lane requires the
fewest lane changes, while Audi indicates all the lanes that can reach
the destination regardless of how many lane changes that would imply.
Both are reasonable UI choices that could be described as "correct".

In the roundabout example, this also mostly works fine.  However, if
the entrance and exit are very close, it might not be feasible for a
car joining in the left-hand lane to change to the right-hand lane in
time to take the exit.  That is the case in the situation reported in
GOSDK-10625, in which GO SDK recommends all five lanes, even though
only two can legally be used to follow the route.

image::2023-05-25T13:19:59+0200-lane-arrow-recommendations/GOSDK-10625.png[width=400]

Therefore, we need a way for GO SDK users to highlight lanes that are
practically usable.

=== Online Mode Considerations

When operating in online mode, lane guidance must be provided via the
routing API.  This API was designed to accomodate the output of NK1
lane guidance.  NK1 only provided one arrow per lane, which could be
recommended, and did not expose lane recommendations (the API was
capable of providing multiple arrows, but customers preferred just
one).  GO SDK's first customer was Amigo, which was already consuming
this API, and that informed the design choices for the GO SDK API.
That is ultimately why BMW's UI is constrained to only show one arrow
per lane.

If we want to add lane recommendations to the existing arrow
recommendations, this will require adapting the routing API too.  This
would also probably require adaptation in most consumers of that API.

== Alternatives
=== 1. Implement Filter in `LaneGuidanceBuilder`

We could implement the filtering logic used by HCP3 inside the
instruction engine, in the output of `LaneGuidanceBuilder`.

==== Advantages

* Single solution applies to all customers
* No disruption to HCP3, hopefully, since the end result should stay
  the same even as the SDK output changes
* Fast to deploy
* Regression/mass tests reflect actual output seen by drivers

==== Disadvantages

* Removes the ability to indicate the right way to drive in
  non-recommended lanes
* Leaves a large technical debt of lane recommendation flags in
  structures that no longer add value
* Would likely have to undo this again to support intended
  functionality for "lane guidance everywhere"

=== 2. Implement Filter in `get_full_lane_guidance_list`

We could implement the filtering logic used by HCP3 inside the
instruction engine, inside `get_full_lane_guidance_list`.  This API is
used by GO SDK, but not by HCP3.

==== Advantages

* Leaves HCP3 unaffected, removing a potential source of risk
* Fast to deploy

==== Disadvantages

* Different solution for different customers, and a surprising
  side-effect of two otherwise equivalent API calls
* Complicates regression tests
* Would likely have to undo this again to support intended
  functionality for "lane guidance everywhere"

=== 3. Implement Filter in Onboard Directions

We could implement the filtering logic used by HCP3 inside the onboard
directions repository, which translates between instruction engine
output and GO SDK output.

==== Advantages

* Leaves HCP3 unaffected, removing a potential source of risk
* Fast to deploy

==== Disadvantages

* Breaks the design of the onboard directions layer, which is intended
  to be dumb translation logic rather than business logic
* Difficult to test in an end-to-end fashion

=== 4. Implement Filter in GO SDK

We could implement the filtering logic used by HCP3 inside GO SDK
itself.  This would require exposing both recommendation flags inside
onboard directions.

==== Advantages

* Leaves HCP3 unaffected, removing a potential source of risk

==== Disadvantages

* Breaks the design of the functional enabler, which is intended to
  provide everything GO SDK needs without additional business logic
* Complicated implementation (relative to option 3)
* Difficult to test in an end-to-end fashion

=== 5. Expose Lane Recommendations in GO SDK

We could add the lane recommendation flag to GO SDK.  This would
require BMW to implement business logic to take advantage of the new
flag, similarly to how HCP3 did this.

==== Advantages

* Provides flexibility for customers to define their own UX, including
  their own business logic
* Consistency between NK2 and GO SDK
* Provides a clear path forward for "lane guidance everywhere"

==== Disadvantages

* Requires additional work from customers including BMW, some of whom
  might regard that business logic as "TomTom's job"
* Disruptive (although backwards-compatible) changes to public APIs
* Also requires changes to the Routing API

=== 6. Adapt the Map

We could attempt to work around the most critical issues by improving
the map.  Lane transitions similar to the roundabout example, that are
impossible due to short road stretches, could be forbidden.

==== Advantages

* Guidance can be fine-tuned for each situation
* Requires no adaptation for consumers

==== Disadvantages

* Slow deployment time
* Possible unanticipated knock-on effects

=== 7. Do Nothing

We could advise BMW that the arrows indicated at the roundabout
instruction are designed to guide the driver onto the roundabout, no
more.  Once on the roundabout, it is up to the driver to decide how to
safely exit.

==== Advantages

* Quick solution
* Implementation is easy to explain

==== Disadvantages

* Makes good guidance impossible to implement for BMW

== Decision

We will accept the current behaviour for the time being, option 7.  We will also suggest improvements to the map, option 6.

Meanwhile, we will discuss further a good long-term solution.

== Consequences

* We have no good story for BMW on how to fix the bad lane guidance
