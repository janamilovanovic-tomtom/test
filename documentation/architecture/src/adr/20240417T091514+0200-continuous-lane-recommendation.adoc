// Copyright (C) 2018 TomTom NV. All rights reserved.

= Continuous Lane Recommendation

== Summary

1. We will re-use the current NK2 API, but change its behaviour
2. Instead of delivering scenarios for upcoming instructions, we will
generate longer, overlapping scenarios from the current car position.
3. We believe this will support existing consumers of the NK2 API.
4. To satisfy the requirements, PSD will need to deliver updated lane
recommendations on each change of position (once per second)
5. PSD will therefore subscribe to lane data updates and hold the
latest data in memory
6. For PSD to match the lane data to the current route, we need to add
the route ID to the data

== Current System

Currently there are two widgets consuming lane data, the Simple Lane
Guidance widget and the Exit View widget.  I will present a simplified
description of how these operate from the NK2 perspective.

Both widgets register listeners with the Trip Service, which in turn
registers a listener with the Lane Guidance Provider.  The Lane
Guidance Provider then listens to changes in position, the upcoming
instructions, and the current instruction trigger state.  When a new
instruction trigger state is reached, it uses the Lane Guidance
Builder to create a lane guidance scenario, which then gets passed to
the consumers.

The Simple Lane Guidance widget can simply display the upcoming lane
recommendations as and when it receives this callback.  Since the
generation of scenarios is related to trigger phases, this will cause
the widget to appear at the correct time to provide the driver
guidance for the upcoming instruction.

The Exit View Widget displays a more complicated 3D exit view.  This
is complicated to render.  Therefore, there is an intermediate
component which I'm calling the Exit View Builder (I do not know what
it is really called).  This listens for upcoming scenarios, and
pre-computes exit views for each upcoming instruction.  Note that
there may be more than one upcoming instruction in each scenario.  It
can then trigger the Exit View Widget to display the scenario at the
appropriate time.

[plantuml, current-lane-recommendation, svg, alt="Sequence diagram of current lane recommendation"]

----

@startuml

participant LaneGuidanceBuilder
participant LaneGuidanceProvider
participant TripService
participant SimpleLaneGuidanceWidget
participant ExitViewBuilder
participant ExitViewWidget

SimpleLaneGuidanceWidget -> TripService : AddNextInstructionListener
ExitViewBuilder -> TripService: AddNextInstructionListener
TripService -> LaneGuidanceProvider : MakeLaneGuidanceProvider
...
LaneGuidanceProvider -> LaneGuidanceBuilder : Generate
LaneGuidanceBuilder -> LaneGuidanceProvider : LaneGuidanceScenario
LaneGuidanceProvider -> TripService : OnLaneGuidanceScenarioChanged
TripService -> SimpleLaneGuidanceWidget : OnNextLaneSegmentsChange
TripService -> ExitViewBuilder : OnNextLaneSegmentsChange
...
ExitViewBuilder -> ExitViewWidget : ExitViewBuilder
...
ExitViewBuilder -> ExitViewWidget : ExitViewBuilder
...
ExitViewBuilder -> ExitViewWidget : ExitViewBuilder

@enduml

----

== With Continuous Lane Guidance

For continuous lane guidance we intend to keep the existing NK2 API
unchanged as far as possible.  That is, the Trip Service will accept
listeners and call them back when scenarios are available using
OnNextLaneSegmentsChange.  Similarly, the Lane Guidance Provider will
accept the Trip Service as a listener, and call it back using
OnLaneGuidanceScenarioChanged.

However, we will change the behaviour of the Lane Guidance Provider.
It will no longer create scenarios based on trigger state.  Instead it
will generate scenarios at fixed intervals.  These will overlap, such
that it is guaranteed that by the point where the existing scenario
only covers 3km ahead of the current car position, it will be replaced
by a new scenario.  See discussion below.

The PSD needs to re-display the upcoming lane recommendations
frequently (probably once per second).  We cannot provide
OnNextLaneSegmentsChange callbacks so frequently.  Therefore the PSD
needs to cache the latest lane data update.  This is described in the
following sequence diagram:

[plantuml, continuous-lane-reocmmendation, svg, alt="Sequence diagram of continuous lane recommendation"]

----

@startuml

participant LaneGuidanceBuilder
participant LaneGuidanceProvider
participant TripService
participant PSD
participant ClusterDisplay

TripService -> LaneGuidanceProvider : MakeLaneGuidanceProvider
...
LaneGuidanceProvider -> LaneGuidanceBuilder : Generate
LaneGuidanceBuilder -> LaneGuidanceProvider : LaneGuidanceScenario
LaneGuidanceProvider -> TripService : OnLaneGuidanceScenarioChanged
TripService -> PSD : OnNextLaneSegmentsChange
...
PSD -> ClusterDisplay : LaneRecommendations
...
PSD -> ClusterDisplay : LaneRecommendations
...
PSD -> ClusterDisplay : LaneRecommendations

@enduml

----

The PSD does need to ensure that the lane data matches the currently
tracked route.  For this it needs the route ID to be included in the
lane data.  This means:

* If a new route is planned, the previous lane data with the old route
  ID should be discarded, and no lane recommendations displayed until
  new lane data arrives
* If the routing engine changes the route path without changing the
  route ID, the old lane recommendations must continue to be applied
  to the new route.  We would therefore hope that no significant route
  changes would be proposed close to the current car position.

If a new route is supplied, the sequence would look like this.  In the
period where the PSD knows about "RouteY" but the lane segments still
refer to "RouteX", no updates should be sent to the cluster display
and no lanes should be recommended.

[plantuml, new-route, svg, alt="Sequence diagram on new route"]

----

@startuml

participant TripService
participant PSD
participant ClusterDisplay

TripService -> PSD : OnRoutesChange ("RouteX")
...
TripService -> PSD : OnNextLaneSegmentsChange ("RouteX")
...
PSD -> ClusterDisplay : LaneRecommendations
...
PSD -> ClusterDisplay : LaneRecommendations
...
TripService -> PSD : OnRoutesChange ("RouteY")
...
TripService -> PSD : OnNextLaneSegmentsChange ("RouteY")
...
PSD -> ClusterDisplay : LaneRecommendations


@enduml

----

If the same route (that is, it has the same ID) has a replanning along
a different road, then the sequence looks like this.  The PSD has no
choice but to continue delivering lane recommendations using the old
data.  No new lane data will arrive for that stretch of the road,
until the next scheduled lane data arrives normally.  We must hope
that any important changes happen over the horizon.


[plantuml, new-roads, svg, alt="Sequence diagram along new roads"]

----

@startuml

participant TripService
participant PSD
participant ClusterDisplay

TripService -> PSD : OnRoutesChange ("RouteX")
...
TripService -> PSD : OnNextLaneSegmentsChange ("RouteX")
...
PSD -> ClusterDisplay : LaneRecommendations
...
PSD -> ClusterDisplay : LaneRecommendations
...
TripService -> PSD : OnRoutesChange ("RouteX")
...
PSD -> ClusterDisplay : LaneRecommendations
...
PSD -> ClusterDisplay : LaneRecommendations


@enduml

----

== Detailed Timing

In the current system, scenarios are delivered around upcoming
instructions.  This means that over some stretches of the route there
is no upcoming lane guidance at all.  It also means that no scenario
is delivered that does not contain an instruction.

The delivered scenario covers from the main trigger point of the
upcoming instruction until 300m after the instruction.  Note that the
300m may include additional instructions.  Since we know each the exit
view for each upcoming instruction is pre-computed as soon as lane
guidance for that instruction arrives, we ensure that any scenario has
at least 300m of coverage after any contained instruction.  This means
that if instructions are close together, scenarios may be artificially
extended.

image::/Users/exon/project/nk2/navigation-instruction-engine/documentation/architecture/src/adr/20240417T091514+0200-continuous-lane-recommendation/current.jpg[width=600]

With the new system, scenarios be produced at a fixed internal, and
will need to be considerably longer.  The latest scenario must at all
times cover at least 3km ahead of the current car position.  This
requires an overlap with subsequent scenarios.  To avoid recomputing
lane guidance too often, we will want the fixed interval to be quite
long.  We have chosen 3km as this overlap distance.
In addition, we will add 100m to account for the time needed to compute a new scenario.
 We will still need to
ensure that scenarios include at least 300m of coverage after any
contained instruction, so the length of scenarios may vary.

image::/Users/exon/project/nk2/navigation-instruction-engine/documentation/architecture/src/adr/20240417T091514+0200-continuous-lane-recommendation/future.jpg[width=600]

This new system breaks the properties of the old one.  There will no
longer be any stretches of the route with no lane guidance.  And there
may be scenarios that contain no instruction.

Note that since 3km is longer than the maximum main trigger distance,
we still guarantee that the scenario containing a particular
instruction will be delivered no later than the main trigger distance
for that instruction.

== Compatibility With Existing Widgets

Our intention here is to deliver an experimental alternative system
that can be used to evaluate the PSD.  For the moment it need not
support the existing use cases, Simple Lane Guidance and Exit View.
However:

1. It must not cause any crash or other distracting behaviour from
those widgets
2. We must have space in the design for supporting all widgets at the
same time

Since the existing API will remain in place, we believe that existing
widgets should behave acceptably.  There is a risk that scenarios that
contain no maneuver at all could cause misbehaviour in these widgets.
However this should be relatively easy to adapt.

The major potential problem is with the Simple Lane Guidance widget.
This may be triggered early, since scenarios are being triggered at
different points.  It may need to be adapted to also take into account
the current trigger state.  But even without that adaptation, this
should only be a minor effect for the evaluation phase.

The Exit View widget should continue to function correctly, based on
our current understanding of how Exit Views are pre-computed and
cached.
