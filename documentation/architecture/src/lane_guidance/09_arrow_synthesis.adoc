// Copyright (C) 2020 TomTom NV. All rights reserved.

[[section-arrow-synthesis]]

== Arrow Synthesis

This content is largely taken from these ADRs:

* `2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections.adoc`.
* Diagrams taken from https://miro.com/app/board/o9J_llhixvo=/?invite_link_id=585666636395[this Miro board].

It is expected that the ADRs will be left in place, whereas this documentation will be updated.

=== Purpose of Arrows

Each lane in each segment in a scenario should be labelled with one or
more arrows.  This should intuitively convey to the driver the purpose
of that lane.  There are several types of arrow serving different
roles for the driver:

* The recommended arrow on the driver's own lane should reassure them
  that they are on route, and support the action given in the current
  instruction.
* Non-recommended arrows on the driver's own lane should indicate that
  staying in this lane or following the driver in front is not enough
  to stay on route, the driver must choose a particular direction.
* Recommended arrows on other lanes indicate potential alternative
  lanes the driver can use to continue on their route, even if that
  departs from the lane-level router's overall recommendation.
* Non-recommended arrows on other lanes indicate what neighbouring
  drivers might be doing.

Arrows are short-horizon information.  Unlike instructions, which may
summarise several twists and turns, arrows only indicate the next
upcoming change in direction.  This means the recommended arrow
direction need not correspond exactly to the direction indicated in
the instruction.  However, to avoid driver confusion, it is desirable
if they agree when possible.

Arrows are also frequently painted on the road and fulfill a similar
role for the driver.  However, these are usually customised for each
intersection, may have a large number of glyphs as well as
alpha-numeric annotation, and cover no consistent maneuver horizon.
Therefore the synthesised arrows need not correspond to the arrows
painted on the road, although again it is desirable if they agree when
possible.

=== Synthesising Arrows at Maneuvers

==== Purpose of arrow synthesis:

For each furcation in the road network along the route, we want to have one on-route lane segment containing arrows.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 1.jpg[width=120]

==== Source and Target segments:

One confusing aspect of arrow synthesis is that it combines
information from two different road models in the map, the routing
model consisting of arcs and the lane model consisting of lane groups.
Both of these model the furcations in the road, but they very often
place the furcation at different places.  For example, here in the
routing model the arc A1 diverges into the arcs A2 and A3.  However in
the lane model the lane group LG2 diverges into the lane groups LG3
and LG4, with the point of divergence happening rather later along the
road.  That is, LG2 covers a portion of A2 and A3.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 6.jpg[width=120]

For this reason we need to work with two different lane segments at
the same time.  The Source Segment corresponds to the lane group where
the lane model diverges.  At that point we assign arrows to lanes, so
it is the "source" of the arrows.  Then there is the Target Segment,
which corresponds to the arc where the routing model diverges.  This
is the maneuver point, and the place where the arrows actually have to
be recorded.  This is therefore the "target" of the arrow synthesis.

[#current_identifying_furcations]
==== Identifying Furcations

A furcation is defined as a node with one on-route arc and outgoing arcs, one of which is on the route.

The incoming arc to the furcation is the starting point for arrow synthesis.  This is called the "target arc".  In the example below, the target arc is A1.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 2.jpg[width=120]

For all arcs at the furcation, we record the relative angle to the target arc in a map:

[#furcation_arc_angle_table]
[literal]
A1 -> 0°
A2 -> -30°
A3 -> 30°

==== Identifying the Target Segment

Next we need to choose the segment that will hold the arrows.  This is called the "target segment".

The target segment is the last lane group before the furcation.  In this case, it is LG3.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 3.jpg[width=120]

We can find that because when we read the arcs and lane groups, we make a mapping:

[literal]
A1 -> LG1
A1 -> LG2
A1 -> LG3
A2 -> LG4
A3 -> LG5

We can choose the last lane group corresponding to the target arc A1.

==== Target Segments Covering Multiple Arcs

Suppose that in fact the lane group is long and extends over the previous arc:

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 4.jpg[width=120]

In this case there will be a mapping from A4 -> LG1, but A1 will not map to any lane group.

Therefore, we must search backwards from A1 through the road network until we find an arc with a lane group.

The last segment on that arc is the target lane segment.

This does not affect the choice of target arc: it is still A1, and LG1 is still the relevant lane group.

==== Parallel Lane Groups

If the end of the arc has multiple lane groups in parallel, it is ambiguous which one to choose.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 5.jpg[width=120]

This should not happen at complex intersections.  The spec suggests
that each arc leading to the intersection should end in one
unambiguous lane group.

We believe there are no cases where there is a physical
separation between two sets of lanes on one road, and the FTX block
models this as two lane groups where the SD map models it as a
single arc.  See
https://jira.tomtomgroup.com/browse/NAV-63608[NAV-63608].

==== Identifying the Source Segment

Having determined the target arc and the target segment, the next step
is to find a source segment.  We will determine the arrows of the
lanes in the source segment, and copy those to the target segment.

One important simplifying aspect of this algorithm is that we can
reliably search forward for a source segment, we never have to look
backwards.  The source segment might be the same as the target
segment, but if it was earlier it would not cover the maneuver point.

To find the source segment we move forward on the route until we find
a segment which connects to multiple outgoing segments.  In this case
the source segment is LG2, which has outgoing segments LG3 and LG4.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 6.jpg[width=120]

We don't want to synthesise arrows in the source segment itself,
because it comes after the maneuver.  Showing arrows here would be
confusing for the driver.  Note however that target and source segment
often coincide.

==== Synthesising Arrows

The next step is to synthesise arrows for each outgoing lane connection in the source segment.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 7.jpg[width=200]

In this case LG2 has two lanes, each of which connects to one outgoing lane.

* For each lane in LG2, for example LANE1
** For each connection, for example the one to LG4 LANE0
*** Find the arc key of the segment, in this case A3
*** Backtrack until we find an arc that has an angle recorded in xref:furcation_arc_angle_table[the arc angle table]
*** Add the angle difference to our set of arrow angles, mapped to the connected segment ID.

Then we use the Angle Quantizer to convert the angles to arrow directions.

* For each lane in LG2, for example LANE1
** For each connection, for example the one to LG4 LANE0
*** Find the quantized arrow for the connected segment, in this case LG4
*** Add that arrow to the lane in the source segment

[#current_assigning_arrows]
==== Assigning the Arrows

Then we use lane connectivity to match those arrows in the source
segment to the corresponding lanes in the target segment, and store
the arrows in the target.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 8.jpg[width=120]

[#lane_groups_same_arc]
==== Lane Groups on the Same Arc

This relies on the segments after the source segment having different
source arcs.  If they lie on the same arc, they will all have the same
angle.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 9.jpg[width=120]

Here LG5 is the source segment, because it's the first segment that splits, into LG3 and LG4.  But LG3 and LG4 both lie on arc A2.

This should not occur according to the spec, which says that
FTX_LANE_GROUP "Groups all lanes that have the same travel direction
and feature references".  Since both LG3 and LG4 have the same feature
reference (A2), they must be modelled by one lane group, not two.

==== Looking Forward Through Arcs and Lane Groups

The source segment may be several steps away from the furcation, both
in terms of arcs and segments.  By the time the segment connectivity
splits, the angle of the arc may not represent the angle of the
furcation.  See the example below, known as the "tuning fork"
scenario:

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 10.jpg[width=280]

In this case we start at the target segment LG3, and the incoming arc / target arc A1.

We search forward to find the first segment which joins to multiple
other segment, which in this case is LG7, and that is the source
segment.

Next, for each lane in LG7, we find the outgoing connections.  One of
these leads to LG9.  We look up the associated arc, which is A7.  From
there we look backwards until we find an arc that is in the table of
angles.  In this case, that is A3.

Then the angle is available: 30°

This is very common at highway exits.  At the furcation itself there
are two branches, one that goes straight and another that goes
slightly right.  But the right-hand branch quickly straightens out to
run parallel with the left-hand branch.  The arrow should be
calculated at the bifurcation point.

[#current_internal_arcs]
==== Internal Arcs

An "internal arc" is one marked as a complex intersection or plural
junction.  These should generally be treated as a single maneuver.  So
when we are looking backwards to find the angle at the junction, we
should stop if we encounter an internal arc.  This will lead to the
angle being calculated between the incoming arc and the first external
arc between the junction and the discovered outgoing lane segment.  If
the discovered outgoing segment is already on a plural junction, we
will not make any effort to look further forward, instead directly
using the arc associated with the lane segment.

Suppose that in the above example, the arc A3 is marked as a plural
junction.  As before we find LG7 as the source segment and LG9 as one
of the outgoing segments.  From LG9 we find the associated arc A7.  We
then backtrack to find arc A5, but not further to A3, because A3 is a
plural junction.  A5 has an angle of 0°, which should produce a "go
straight" arrow.

image::../adr/2021-11-05T15:59:03+0100-arrow-synthesis-complex-intersections/Current Arrow Synthesis - Frame 11.jpg[width=350]

=== Quantising Angles

To be written NAV-120125

=== Propagating Arrows

To be written NAV-120126
